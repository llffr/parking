<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Admin</title>
    <style>
	body {
		display: flex;
		justify-content: center;
		flex-direction: column;
		height: 100vh;
		align-items: center;
	}
    </style>
  </head>
  <body>

  <div id="pantallaAcceso">
    <h2>Ingresa el c√≥digo para acceder</h2>
    <input type="password" id="codigoAcceso" placeholder="C√≥digo">
    <button onclick="verificarAcceso()">Entrar</button>
    <p id="mensajeError" style="color:red;"></p>
  </div>

  <div id="contenido" style="display: none;">
    <button onclick="mostrarHistorial()">üìã Ver Historial de Reservas</button>

    <div id="historial" style="margin-top: 20px; display: none;">
      <h2>Historial</h2>
      <table border="1" cellpadding="8">
        <thead>
          <tr>
            <th>DNI</th>
            <th>Placa</th>
            <th>Nombre</th>
            <th>Tarjeta</th>
            <!-- <th>Foto</th> -->
            <th>Espacio</th>
            <!-- <th>Estado</th> -->
            <th>Entrada</th>
            <th>Salida</th>
          </tr>
        </thead>
        <tbody id="tablaHistorial"></tbody>
      </table>
    </div>
  </div>

    <script>
      function mostrarHistorial() {
        const contenedor = document.getElementById('historial');
        contenedor.style.display = contenedor.style.display === 'none' ? 'block' : 'none';

        fetch('/historial')
          .then(res => res.json())
          .then(data => {
            const tabla = document.getElementById('tablaHistorial');
            tabla.innerHTML = '';

            if (data.length === 0) {
              tabla.innerHTML = '<tr><td colspan="9">No hay reservas registradas</td></tr>';
            } else {
              data.forEach(r => {
                tabla.innerHTML += `
              <tr>
                <td>${r.dni}</td>
                <td>${r.placa}</td>
                <td>${r.nombre_conductor}</td>
                <td>${r.tarjeta_propiedad}</td>
                <!-- <td>${r.foto ? `<img src="/uploads/${r.foto}" width="80">` : 'Sin foto'}</td> -->
                <td>${r.codigo_espacio}</td>
                <!-- <td>${r.estado || 'N/A'}</td> -->
                <td>${r.hora_entrada ? new Date(r.hora_entrada).toLocaleString() : '-'}</td>
                <td>${r.hora_salida ? new Date(r.hora_salida).toLocaleString() : '-'}</td>
              </tr>
            `;
              });
            }
          })
          .catch(err => {
            console.error('Error al cargar historial:', err);
            alert('No se pudo obtener el historial.');
          });
      }

      function actualizarHistorial() {
        fetch('/historial')
          .then(res => res.json())
          .then(data => {
            const historial = document.getElementById('tablaHistorial');
            if (!historial) return;

            let html = '';

            data.forEach(r => {
              html += `
          <tr>
            <td>${r.dni}</td>
            <td>${r.placa}</td>
            <td>${r.codigo_espacio}</td>
            <td>${r.nombre_conductor}</td>
            <td>${r.tarjeta_propiedad}</td>
            <!-- <td>${r.foto ? `<img src="/uploads/${r.foto}" width="80">` : 'Sin foto'}</td> -->
            <td>${r.hora_entrada ? new Date(r.hora_entrada).toLocaleString() : '-'}</td>
            <td>${r.hora_salida ? new Date(r.hora_salida).toLocaleString() : '-'}</td>
          </tr>
        `;
            });

            historial.innerHTML = html;
          })
          .catch(err => {
            console.error('‚ùå Error al actualizar historial:', err);
            const historial = document.getElementById('tablaHistorial');
            if (historial) {
              historial.innerHTML = '<tr><td colspan="8">‚ùå No se pudo cargar el historial.</td></tr>';
            }
          });
      }

      function verificarAcceso() {
	      const codigo = document.getElementById('codigoAcceso').value;
	      const codigoValido = "1234"; 

	      if (codigo === codigoValido) {
		      document.getElementById('pantallaAcceso').style.display = 'none';
		      document.getElementById('contenido').style.display = 'block';
	      } else {
		      document.getElementById('mensajeError').textContent = 'C√≥digo incorrecto';
	      }
      }
    </script>
  </body>
</html>
