<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Mapa de Estacionamiento</title>
    <link rel="stylesheet" href="./css/style.css">
  </head>
  <body>
    <h1>Mapa de Estacionamiento</h1>
    <div id="mapa"></div>

    <a href="reporte.html">Reportar un problema</a>

    <!-- Formulario de reserva -->
    <div id="formulario">
      <form id="formularioReserva" enctype="multipart/form-data">
        <input type="hidden" name="codigo_espacio" id="codigoEspacioInput" />
        <label>DNI:</label><br><input type="text" name="dni" required /><br>
        <label>Placa:</label><br><input type="text" name="placa" required /><br>
        <label>Nombre del conductor:</label><br><input type="text" name="nombre_conductor" required /><br>
        <label>Tarjeta de propiedad:</label><br><input type="text" name="tarjeta_propiedad" required /><br>
        <label>Foto (simulada):</label><br><input type="file" name="foto" /><br><br>
        <button type="submit">Reservar</button>
        <button type="button" onclick="cerrarFormulario()">Cancelar</button>
      </form>
    </div>

    <script>
      function obtenerEspacios() {
        fetch('/espacios')
          .then(res => res.json())
          .then(data => generarMapa(data))
          .catch(err => console.error(err));
      }

      function generarMapa(espacios) {
        const mapa = document.getElementById('mapa');
        let html = '<table><tr>';
        espacios.forEach((espacio, i) => {
          if (i > 0 && i % 5 === 0) html += '</tr><tr>';
          html += `
          <td class="${espacio.estado}">
            <strong>${espacio.codigo}</strong><br>
            Estado: ${espacio.estado}<br>

            ${espacio.estado === 'libre' 
                ? `<button onclick="abrirFormulario('${espacio.codigo}')">Reservar</button>` 
                : `<button disabled style="opacity: 0.5; cursor: not-allowed;">Reservar</button>`}

            ${espacio.estado === 'reservado' 
                ? `<button onclick="marcarIngreso('${espacio.codigo}')">Ingreso</button>` 
                : `<button disabled style="opacity: 0.5; cursor: not-allowed;">Ingreso</button>`}

            ${espacio.estado === 'ocupado' 
                ? `<button onclick="marcarSalida('${espacio.codigo}')">Salida</button>` 
                : `<button disabled style="opacity: 0.5; cursor: not-allowed;">Salida</button>`}
          </td>
        `;
        });
        html += '</tr></table>';
        mapa.innerHTML = html;
      }

      function abrirFormulario(codigo) {
        document.getElementById('codigoEspacioInput').value = codigo;
        document.getElementById('formulario').style.display = 'block';
      }

      function cerrarFormulario() {
        document.getElementById('formulario').style.display = 'none';
      }

      document.getElementById('formularioReserva').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch('/reservar', {
          method: 'POST',
          body: formData
        })
          .then(res => res.text())
          .then(msg => {
            mostrarModal(msg);
            cerrarFormulario();
            obtenerEspacios();
          })
          .catch(err => console.error(err));
      });

      function marcarIngreso(codigo) {
        fetch('/ingresar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ codigo_espacio: codigo })
        })
          .then(res => res.text())
          .then(msg => {
            mostrarModal(msg);
            obtenerEspacios();
            //actualizarHistorial();
          });
      }

      function marcarSalida(codigo) {
        fetch('/salir', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ codigo_espacio: codigo })
        })
          .then(res => res.text())
          .then(msg => {
            mostrarModal(msg);
            obtenerEspacios();
            //actualizarHistorial();
          });
      }

      obtenerEspacios();

      function mostrarModal(mensaje) {
        document.getElementById('modal-message').innerText = mensaje;
        document.getElementById('modal').style.display = 'flex';
	      setTimeout(() => {
		      cerrarModal();
	      }, 800);
      }

      function cerrarModal() {
        document.getElementById('modal').style.display = 'none';
      }

      // refresh table. form not visible
      setInterval(() => {
	      const formulario = document.getElementById('formulario');
	      if (formulario.style.display !== 'block') {
		      obtenerEspacios();
	      }
      }, 5000);

    </script>

    <!-- Modal personalizado -->
    <div id="modal" style="display:none;">
      <div id="modal-content">
        <p id="modal-message"></p>
        <!-- <button onclick="cerrarModal()">Cerrar</button> -->
      </div>
    </div>

  </body>
</html>
